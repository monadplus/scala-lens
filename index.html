<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>The magic of composition</title>

		<!--<link rel="stylesheet" href="css/reset.css">-->
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/beige.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/solarized-light.css">

		<style>
			code.smaller {
				font-size: 0.6em;
				line-height: 1.2em;
			}
    	</style>

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<!--Intro-->
				<section>
					<section>
						<h2><a>The magic of composition</a></h2>
						<h3>Diving into van Laarhoven optics</h3>
						<p><small>Arnau Abella - Software Engineer @ Agilogy</small></p>
						<p><small>May 3th, 2019 | Barcelona, Spain</small></p>
						<br/><br/>
						<small>Sources: <a href="https://github.com/monadplus/scala-lenses" target="_blank">here</a></small>
						<aside class="notes">
							Remark the repository.
						</aside>
					</section>
					<section>
						<h3><a>About me</a></h3>
						<!--<br/>-->
						<div style="display: block; height: 80%; width: 80%; margin-left: auto; margin-right: auto">
							<img src="./images/github.png"/>
						</div>
						<p><small>More information <a href="https://monadplus.github.io/" target="_blank">here</a></small></p>
					</section>
				</section>
				<!--Motivation-->
				<section>
					<section data-markdown>
						<textarea data-template>
							### Motivation

							Let's update a nested data structure in plain scala.
							<!-- .element: class="fragment" data-fragment-index="1" -->

							```scala
							case class Street(number: Int, name: String)
							case class Address(city: String, street: Street)
							case class Company(name: String, address: Address)
							case class Employee(name: String, company: Company)
							```
							<!-- .element: class="fragment" data-fragment-index="2" -->

							```scala
							val employee =
							  Employee(
							    name = "john",
							    company = Company(
							      name = "awesome inc",
							      address =  Address("london", Street(23, "high street"))
							    )
							  )
							```
							<!-- .element: class="fragment" data-fragment-index="2"-->
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							Plain scala

							```scala
							employee.copy(
							  company = employee.company.copy(
								address = employee.company.address.copy(
								  street = employee.company.address.street.copy(
									name = employee.company.address.street.name.capitalize // luckily capitalize exists
								  )
								)
							  )
							)
							```
						</textarea>
					</section>
					<section data-markdown>
						<textarea data-template>
							Using lenses

							```scala
							(company composeLens
							 address composeLens
							 street composeLens streetName).modify(_.capitalize)(employee)
							```
						</textarea>
					</section>
				</section>
				<!--Libraries-->
				<section>
					<section data-markdown>
						<textarea data-template>
							## Libraries

							Lenses provides __more composable__ versions of the abstractions you already known how to use in Haskell/Scala.

							  - [lenses](https://github.com/ekmett/lens#lens-lenses-folds-and-traversals) (haskell)
							  - [monocle](https://github.com/julien-truffaut/Monocle) (scala)
						</textarea>
					</section>
					<section>
						<p>Both libraries provides rich APIs to work with lenses and a battery of utilities to make your life easier.</p>
						<aside class="notes">
							Monocle is easy to use.
						</aside>
					</section>
					<section>
						<img src="./images/signature.png"/>
						<img class="fragment" src="http://www.reactiongifs.com/r/lolof1.gif"/>
					</section>
				</section>
				<!--hierarchy-->
				<section>
					<section>
						<h3>Lenses hierarchy</h3>
					</section>
					<section>
						<p><a>Lenses (haskell)</a></p>
						<img src="./images/lens-hierarchy.png" style="width: 600px; height: 500px;"/>
						<aside class="notes">
							A lot of type aliases
						</aside>
					</section>
					<section>
						<p><a>Monocle (scala)</a></p>
						<img src="./images/monocle-hierarchy.png" style="width: 500px; height: 500px;"/>
					</section>
				</section>
				<!--Composition-->
				<section>
					<h3>Composition</h3>
					<p>The result is their lowest upper bound in the hierarchy (or an error if that bound doesn't exist).</p>
					<div style="display: block; height: 80%; width: 80%; margin-left: auto; margin-right: auto">
						<img src="./images/composition.png"/>
					</div>
				</section>
				<!--Fold-->
				<section>
					<section>
						<h3>Fold</h3>
						<img src="./images/monocle-hierarchy.png" style="width: 500px; height: 500px;"/>
					</section>
					<section>
						<h3>Definition</h3>
						<pre><code class="scala" embed="FoldExample.scala" line-from="10" line-to="15"></code></pre>
						<aside class="notes">
							Fold = Foldable
							Extract results from container
						</aside>
					</section>
					<section>
						<h3>The signature</h3>
						<pre><code class="scala" embed="FoldExample.scala" line-from="20" line-to="22"></code></pre>
					</section>
					<section>
						<h3>Example</h3>
						<pre class="fragment"><code class="scala" embed="FoldExample.scala" line-from="32" line-to="33"></code></pre>
						<pre class="fragment"><code class="scala" embed="FoldExample.scala" line-from="35" line-to="41"></code></pre>
						<pre class="fragment"><code class="scala" embed="FoldExample.scala" line-from="43" line-to="49"></code></pre>
					</section>
					<section>
						<pre class="fragment"><code class="scala" embed="FoldExample.scala" line-from="51" line-to="52"></code></pre>
						<pre class="fragment"><code class="scala" embed="extras/First.scala" line-from="5" line-to="15"></code></pre>
						<pre class="fragment"><code class="scala" embed="FoldExample.scala" line-from="54" line-to="59"></code></pre>
					</section>
				</section>
				<!--Getter-->
				<section>
					<section>
						<h3>Getter</h3>
						<img src="./images/monocle-hierarchy.png" style="width: 500px; height: 500px;"/>
					</section>
					<section>
						<h3>Definition</h3>
						<p class="fragment"><small>Everything you can do with a function, you can do with a Getter.</small></p>
						<pre class="fragment"><code class="haskell">
Getter :: (s -> a)

	   f ::     (s -> a)
	   f_cps ::  s -> ((a -> r) -> r)
	   f_cps :: (a -> r) -> s -> r


type Getting r s a = (a -> Const r a) -> s -> Const r s
type Getter s a = forall r. Getting r s a
</code></pre>
						<aside class="notes">
							Getter = Function
						</aside>
					</section>
					<section>
						<h3>Example</h3>
						<pre><code class="scala" embed="GetterExample.scala" line-from="31" line-to="41"></code></pre>
					</section>
				</section>
				<!--Setter-->
				<section>
					<section>
						<h3>Setter</h3>
						<img src="./images/monocle-hierarchy.png" style="width: 500px; height: 500px;"/>
					</section>
					<section>
						<h3>Definition</h3>
						<p class="fragment"><small>Everything you can do with a Functor, you can do with a Setter.</small></p>
						<pre class="fragment"><code class="scala" embed="SetterExample.scala" line-from="10" line-to="20"></code></pre>
						<aside class="notes">
							Setter = Functor
							Modify content but not enumerate it.
						</aside>
					</section>
					<section>
						<h3>Example</h3>
						<pre class="fragment"><code class="scala" embed="SetterExample.scala" line-from="28" line-to="31"></code></pre>
						<pre class="fragment"><code class="scala" embed="SetterExample.scala" line-from="36" line-to="41"></code></pre>
						<pre class="fragment"><code class="scala" embed="SetterExample.scala" line-from="45" line-to="46"></code></pre>
					</section>
					<section>
						<h3>Derivation</h3>
						<pre class="fragment"><code class="scala" embed="SetterExample.scala" line-from="48" line-to="52"></code></pre>
					</section>
					<section>
						<h3>Laws</h3>
						<pre class="fragment"><code class="scala" embed="SetterExample.scala" line-from="55" line-to="68"></code></pre>
					</section>
				</section>
				<!--Composition break-->
				<section data-markdown="./core/src/main/scala/io/monadplus/scalalens/composition.md"
						 data-separator="^\n\n\n"
						 data-separator-vertical="^\n\n">

				</section>
				<!--Traversal-->
				<section>
					<section>
						<h3>Traversal</h3>
						<img src="./images/monocle-hierarchy.png" style="width: 500px; height: 500px;"/>
					</section>
					<section>
						<h3>Definition</h3>
						<p class="fragment"><small>Everything you can do with a Traversable, you can do with a Traversal.</small></p>
						<pre class="fragment"><code class="scala" embed="TraversalExample.scala" line-from="9" line-to="13"></code></pre>
					</section>
					<section>
						<h3>Example</h3>
						<pre class="fragment"><code class="scala" embed="TraversalExample.scala" line-from="22" line-to="32"></code></pre>
					</section>
					<section>
						<pre class="fragment"><code class="scala" embed="TraversalExample.scala" line-from="34" line-to="39"></code></pre>
						<pre class="fragment"><code class="scala" embed="TraversalExample.scala" line-from="41" line-to="54"></code></pre>
					</section>
					<section>
						<h3>Laws</h3>
						<pre class="fragment"><code class="scala" embed="TraversalExample.scala" line-from="57" line-to="64"></code></pre>
					</section>
				</section>
				<!--Optional-->
				<section>
					<section>
						<h3>Optional</h3>
						<img src="./images/monocle-hierarchy.png" style="width: 500px; height: 500px;"/>
					</section>
					<section data-transition="fade-in fade-out">
						<h3>Definition</h3>
						<p class="fragment"><small>A lens where the zoomed element may not exist.</small></p>
						<pre class="fragment"><code class="scala" embed="OptionalExample.scala" line-from="6" line-to="10"></code></pre>
						<aside class="notes">
							Optional is not interesting.
							Not found in lenses.
						</aside>
					</section>
					<section>
						<h3>Example</h3>
						<pre class="fragment"><code class="scala" embed="OptionalExample.scala" line-from="14" line-to="22"></code></pre>
						<pre class="fragment"><code class="scala" embed="OptionalExample.scala" line-from="24" line-to="25"></code></pre>
						<pre class="fragment"><code class="scala" embed="OptionalExample.scala" line-from="27" line-to="31"></code></pre>
					</section>
				</section>
				<!--Lens-->
				<section>
					<section>
						<h3>Lens</h3>
						<img src="./images/monocle-hierarchy.png" style="width: 500px; height: 500px;"/>
					</section>
					<section data-transition="fade-in fade-out">
						<h3>Definition</h3>
						<pre class="fragment"><code class="scala" embed="LensExample.scala" line-from="15" line-to="17"></code></pre>
						<pre class="fragment"><code class="scala" embed="LensExample.scala" line-from="12" line-to="13"></code></pre>
					</section>
					<section>
						<h3>Example</h3>
						<pre class="fragment"><code class="scala" embed="LensExample.scala" line-from="30" line-to="33"></code></pre>
						<pre class="fragment"><code class="scala" embed="LensExample.scala" line-from="35" line-to="36"></code></pre>
						<pre class="fragment"><code class="scala" embed="LensExample.scala" line-from="38" line-to="39"></code></pre>
					</section>
					<section data-transition="zoom-in fade-out">
						<pre><code class="scala" embed="LensExample.scala" line-from="41" line-to="45"></code></pre>
						<pre class="fragment"><code class="scala" embed="LensExample.scala" line-from="52" line-to="58"></code></pre>
					</section>
					<section>
						<h3>Laws</h3>
						<pre class="fragment"><code class="scala" embed="LensExample.scala" line-from="67" line-to="69"></code></pre>
						<pre class="fragment"><code class="scala" embed="LensExample.scala" line-from="71" line-to="73"></code></pre>
						<pre class="fragment"><code class="scala" embed="LensExample.scala" line-from="75" line-to="77"></code></pre>
					</section>
					<section>
						<h3>Derivation</h3>
						<pre><code class="scala">
  case class Address(streetNumber: Int, streetName: String)
  case class Person(name: String, age: Int, address: Address)
						</code></pre>
						<pre class="fragment"><code class="scala" embed="LensExample.scala" line-from="91" line-to="96"></code></pre>
						<pre class="fragment"><code class="scala" embed="LensExample.scala" line-from="98" line-to="103"></code></pre>
					</section>
					<section data-transition="none-in fade-out">
						<pre><code class="scala" embed="LensExample.scala" line-from="88" line-to="89"></code></pre>
						<pre class="fragment" data-fragment-index="1"><code class="scala" embed="LensExample.scala" line-from="105"
																			line-to="105"></code></pre>
						<pre class="fragment" data-fragment-index="1"><code class="scala" embed="LensExample.scala" line-from="107" line-to="117"></code></pre>
						<aside class="notes">
							Polymorphic lens can also be derived t he same way.
						</aside>
					</section>
				</section>
				<!--Prism-->
				<section>
					<section>
						<h3>Prism</h3>
						<img src="./images/monocle-hierarchy.png" style="width: 500px; height: 500px;"/>
					</section>
					<section data-transition="fade-in fade-out">
						<h3>Definition</h3>
						<p class="fragment"><small>A Prism usually encodes  the relation between a Coproduct type and one of its elements.</small></p>
						<pre class="fragment">
							<code class="haskell">type Prism s t a b = forall p f. (Choice p, Applicative f) => p a	(f b) -> p s (f t)</code>
						</pre>
						<p class="fragment">
							<small>A <b>Prism</b> is a <b>Traversal</b> that can also be turned around with re to obtain a <b>Getter</b> in
							the opposite direction.</small>
						</p>
					</section>
					<section>
						<h3>Example</h3>
						<pre class="fragment"><code class="scala" embed="PrismExample.scala" line-from="34" line-to="40"></code></pre>
						<pre class="fragment"><code class="scala" embed="PrismExample.scala" line-from="31" line-to="31"></code></pre>
						<pre class="fragment"><code class="scala" embed="PrismExample.scala" line-from="55" line-to="58"></code></pre>
					</section>
					<section>
						<h3>Laws</h3>
						<pre class="fragment"><code class="scala" embed="PrismExample.scala" line-from="64" line-to="73"></code></pre>
					</section>
					<section data-background-image="./images/circe.png">
						<h3 style="color: green">Optics are used in the real world!</h3>
					</section>
					<section>
						<h3>Real World Example</h3>
						<div class="fragment">
							<pre><code class="scala" embed="PrismExample.scala" line-from="76" line-to="79"></code></pre>
							<pre><code class="scala" embed="PrismExample.scala" line-from="81" line-to="99"></code></pre>
						</div>
					</section>
					<section>
						<pre><code class="scala" embed="PrismExample.scala" line-from="141" line-to="148"></code></pre>
					</section>
				</section>
				<!--Iso-->
				<section>
					<section>
						<h3>Iso</h3>
						<img src="./images/monocle-hierarchy.png" style="width: 500px; height: 500px;"/>
					</section>
					<section data-transition="fade-in fade-out">
						<h3>Definition</h3>
						<p class="fragment"><small>A valid Lens and a valid Prism.</small></p>
						<pre class="fragment">
							<code class="haskell">type Iso s t a b = forall p f. (Profunctor p, Functor f) => p a (f b) -> p s (f t) </code>
						</pre>
					</section>
				</section>
				<!--Alias-->
				<section data-markdown="./core/src/main/scala/io/monadplus/scalalens/alias.md"
						 data-separator="^\n\n\n"
						 data-separator-vertical="^\n\n">
					<aside class="notes">
						Types are polymorphics.
					</aside>
				</section>
				<!--Monocle functions-->
				<section>
					<section data-markdown>
						<textarea data-template>
							## Helpers

							Here is a list of all available utility type classes from monocle:
							 - At
							 - Cons & Cons1
							 - Each
							 - Field1, ..., Field6 & Fields
							 - FilterIndex
							 - Index
							 - ...
						</textarea>
					</section>
					<section>
						<h3>Example: At</h3>
						<pre><code class="scala" embed="functions/atExample.scala" line-from="22" line-to="35"></code></pre>
						<pre class="fragment"><code class="scala" embed="functions/atExample.scala" line-from="39" line-to="42"></code></pre>
					</section>
					<section>
						<h3>Example: Refined + At</h3>
						<pre><code class="scala" embed="functions/atExample.scala" line-from="47" line-to="49"></code></pre>
					</section>
					<section>
						<h3>Example: Each</h3>
						<pre><code class="scala" embed="functions/eachExample.scala" line-from="12" line-to="13"></code></pre>
						<pre><code class="scala" embed="functions/eachExample.scala" line-from="22" line-to="23"></code></pre>
					</section>
				</section>
				<!--Conclusion-->
				<section>
					<section>
						<h2>Conclusion</h2>
						<p>Lenses are not magic!</p>
						<p>
							<small>Lenses provide a rich and
								<b>composable</b> abstraction to manipulate functional data structures in an imperative way</small>
						</p>
					</section>
					<section>
						<p><small>Monocle is a wonderful library.</small></p>
						<img src="./images/monocle-logo.png"/>
						<p><small>Give it a try !</small></p>
					</section>
				</section>
				<!--Next steps-->
				<section>
					<section data-markdown>
						<textarea data-template>
							## Next steps

							For the curious ones, [monocle](https://github.com/julien-truffaut/Monocle) has more to offer:

							 - scala.js compatibility <!-- .element: class="fragment" -->
							 - scala native compatibility<!-- .element: class="fragment" -->
							 - Generics integration<!-- .element: class="fragment" -->
							 - Refined integration<!-- .element: class="fragment" -->
							 - Reader/State instances<!-- .element: class="fragment" -->
							 - Laws testing<!-- .element: class="fragment" -->
						</textarea>
					</section>
					<section>
						<p>For the brave ones, dive into <a href="https://github.com/ekmett/lens#lens-lenses-folds-and-traversals" target="_blank">
							lenses</a> and master 'em all!</p>
						<img src="./images/kmett.jpg"/>
					</section>
				</section>
				<!--acknowledge-->
				<section>
					<section>
						<h3>Acknowledgements</h3>
						<p>This talk wouldn't be possible without countless hours of work of:</p>
						<ul>
							<li>
								<p>J. Truffaut et al (<a href="https://github.com/julien-truffaut/Monocle" target="_blank">monocle</a>)</p>
							</li>
							<li>
								<p>E. Kmett et al (<a href="https://hackage.haskell.org/package/lens" target="_blank">lenses</a>)</p>
							</li>
							<li>
								<p>Many others</p>
							</li>
						</ul>
					</section>
					<section>
						<p>
							Kudos to <a href="https://github.com/kubukoz" target="_blank">Jakub Kozłowski</a> for helping me with the slides.
						</p>
					</section>
				</section>
				<!--Questions-->
				<section>
					<h2>Questions ?</h2>
					<ul>
						<li>Reach me out on Gitter <a href="https://github.com/monadplus" target="_blank">@monadplus</a>!</li>
					</ul>
				</section>
			</div>
		</div>

		<script src="js/reveal.js"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

		<script>
		    const Embed = ({fetchFileContents}) => {
				return {
					insertCode: async elem => {
						const path = elem.getAttribute("embed");
						const lineFrom = elem.getAttribute("line-from") || 1
						const lineTo = elem.getAttribute("line-to") || undefined
						const fileContents = await fetchFileContents(path);
						elem.textContent = fileContents.split("\n").slice(lineFrom - 1, lineTo).join("\n")
					},
					async init() {
						const self = this;
						const elems = document.querySelectorAll("[embed]");
						await Promise.all([...elems].map(self.insertCode));
						console.log(`Inserted code for ${elems.length} node(s)`);
					}
				};
			};

			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					<!--{ src: 'plugin/highlight/highlight.js', async: true }-->
					 {
						src: 'plugin/highlight/highlight.js', async: true, callback: function () {
							hljs.initHighlightingOnLoad();
						}
					}
				]
			});
			Reveal.configure({
			  navigationMode: 'linear'
			});

			axios.defaults.baseURL = './core/src/main/scala/io/monadplus/scalalens/';
			Embed({
				fetchFileContents: path => axios.get(path).then(r => r.data)
			}).init();
		</script>
	</body>
</html>
